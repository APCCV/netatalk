#! /bin/sh
# Copyright (c) 1996-2001 SuSE GmbH Nuernberg, Germany.  All rights reserved.
#
# Author: 
#       Reinhold Sojer, <reinhold@suse.de>
#       Olaf Hering, <olh@suse.de>
# 
### BEGIN INIT INFO
# Provides:       netatalk
# Required-Start: $local_fs
# Required-Stop: $local_fs
# Should-Start:  $network $named $remote_fs $syslog avahi-daemon
# Should-Stop:   $remote_fs $network $syslog
# Default-Start:  3 5
# Default-Stop:
# Description:    Netatalk AFP fileserver for Macintosh clients
### END INIT INFO

# Netatalk :NETATALK_VERSION:

. /etc/rc.status

# startup code for everything
atalk_startup() {
    if [ -x :SBINDIR:/cnid_metad ] ; then
        echo -n "  Starting cnid_metad "
        startproc :SBINDIR:/cnid_metad
        rc_status -v
    fi

    if [ -x :SBINDIR:/afpd ] ; then
        echo -n "  Starting afpd "
        startproc :SBINDIR:/afpd
        rc_status -v
    fi

    touch /var/lock/subsys/atalk 
}

case "$1" in
    start)
        if test ! -z "$UID" -a "$UID" != 0 ; then
            echo "you have to be root to start netatalk daemons"
            rc_failed
        else
            echo "Starting netatalk..."
            atalk_startup
        fi
        ;;
    stop)
        echo -n "Shutting down netatalk"
        killproc -TERM :SBINDIR:/cnid_metad
        killproc -TERM :SBINDIR:/afpd
        rc_status -v
        ;;
    restart|reload|force-reload)
        $0 stop
        $0 start
        rc_status
        ;;
    status)
        echo "Checking for netatalk services"
        checkproc :SBINDIR:/cnid_metad && echo -n " cnid_metad: OK      " || echo -n " cnid_metad: No process   "
        checkproc :SBINDIR:/afpd && echo "afpd: OK" || echo "afpd: No process"
        # assume that afpd is the "main" process ...
        checkproc :SBINDIR:/afpd
        rc_status -v
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

rc_exit
